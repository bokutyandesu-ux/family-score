<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Coin</title>

<style>
body{
font-family:sans-serif;
margin:0;
background:linear-gradient(135deg,#eaf6ff,#ffffff);
}
.container{
max-width:900px;
margin:auto;
padding:20px;
}
.topbar{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}
.card{
background:white;
padding:15px;
margin:10px 0;
border-radius:15px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
text-align:center;
}
.rank1{border-left:6px solid gold;}
.rank2{border-left:6px solid silver;}
.rank3{border-left:6px solid #cd7f32;}
button{
background:#0077ff;
color:white;
border:none;
padding:8px 14px;
border-radius:8px;
margin:5px;
cursor:pointer;
}
input,select{
padding:8px;
border-radius:8px;
border:1px solid #ccc;
margin:5px;
width:90%;
}
.hidden{display:none;}
@media(min-width:700px){
.flex{display:flex;gap:20px;}
.left,.right{flex:1;}
}
</style>
</head>

<body>
<div class="container">

<div class="topbar">
<h2>ğŸ¦ Family Coin</h2>
<div>
<span id="loginStatus">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
<button onclick="toggleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
</div>

<div id="loginBox" class="hidden card">
<select id="loginUser"></select><br>
<input type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
<button onclick="login()">å…¥ã‚‹</button>
</div>

<div class="flex">
<div class="left">
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="ranking"></div>
</div>

<div class="right">

<h3>ğŸ’¸ é€é‡‘</h3>
<div id="transferBox" class="hidden">
<select id="toUser"></select><br>
<input type="number" id="amount" placeholder="ãƒã‚¤ãƒ³ãƒˆ"><br>
<input type="text" id="reason" placeholder="ç†ç”±ï¼ˆå¿…é ˆï¼‰"><br>
<button onclick="transfer()">é€ã‚‹</button>
</div>
<div id="needLogin">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨é€é‡‘ã§ãã¾ã™</div>

<hr>

<h3>ğŸ”‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå…„ï¼‰</h3>
<input type="password" id="adminPass">
<button onclick="adminLogin()">ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</button>

<div id="adminPanel" class="hidden">
<select id="adminUser"></select><br>
<input type="number" id="adminAmount" placeholder="å¢—æ¸›ãƒã‚¤ãƒ³ãƒˆ"><br>
<input type="text" id="adminReason" placeholder="ç†ç”±ï¼ˆå¿…é ˆï¼‰"><br>
<button onclick="adminChange()">å¤‰æ›´</button>

<h4>ğŸ“œ å±¥æ­´ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</h4>
<div id="history"></div>
</div>

</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  doc, 
  updateDoc, 
  addDoc,
  query,
  orderBy,
  serverTimestamp,
  increment
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAJhDW-qF9hcGrlu70ythFbp2mOsqu9G-I",
  authDomain: "family-score.firebaseapp.com",
  projectId: "family-score",
  storageBucket: "family-score.firebasestorage.app",
  messagingSenderId: "24020011568",
  appId: "1:24020011568:web:db45e1bc7ee92d40cc7bf5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let users = [];
let currentUser = null;
let isAdmin = false;
const adminPassword = "nandesitteru";


// =======================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿
// =======================
async function loadUsers(){
  const snapshot = await getDocs(collection(db,"users"));
  users = [];
  snapshot.forEach(docSnap=>{
    users.push({id:docSnap.id,...docSnap.data()});
  });
  render();
}


// =======================
// å±¥æ­´èª­ã¿è¾¼ã¿ï¼ˆæœ€æ–°é †ï¼‰
// =======================
async function loadHistory(){
  const q = query(
    collection(db,"history"),
    orderBy("createdAt","desc")
  );

  const snapshot = await getDocs(q);
  let html = "";

  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    html += `
      ${d.date || ""} | ${d.text || ""}<br>
    `;
  });

  document.getElementById("history").innerHTML = html || "å±¥æ­´ãªã—";
}


// =======================
// è¡¨ç¤ºæ›´æ–°
// =======================
function render(){

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  let sorted=[...users].sort((a,b)=>b.score-a.score);
  let html="";
  sorted.forEach((u,i)=>{
    html+=`
      <div class="card">
        ${i+1}ä½<br>
        <b>${u.name}</b><br>
        ${u.score} pt
      </div>
    `;
  });
  document.getElementById("ranking").innerHTML=html;

  // ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  const loginSel=document.getElementById("loginUser");
  const toSel=document.getElementById("toUser");
  const adminSel=document.getElementById("adminUser");

  if(loginSel){
    loginSel.innerHTML="";
    users.forEach(u=>{
      loginSel.innerHTML+=`<option>${u.name}</option>`;
    });
  }

  if(toSel){
    toSel.innerHTML="";
    users.forEach(u=>{
      if(u.name!==currentUser){
        toSel.innerHTML+=`<option>${u.name}</option>`;
      }
    });
  }

  if(adminSel){
    adminSel.innerHTML="";
    users.forEach(u=>{
      adminSel.innerHTML+=`<option>${u.name}</option>`;
    });
  }

  if(currentUser){
    document.getElementById("transferBox").classList.remove("hidden");
    document.getElementById("needLogin").classList.add("hidden");
  }else{
    document.getElementById("transferBox").classList.add("hidden");
    document.getElementById("needLogin").classList.remove("hidden");
  }
}


// =======================
// ãƒ­ã‚°ã‚¤ãƒ³
// =======================
window.toggleLogin = function(){
  document.getElementById("loginBox").classList.toggle("hidden");
}

window.login = function(){
  const name=document.getElementById("loginUser").value;
  const pass=document.getElementById("loginPass").value;

  const user=users.find(u=>u.name===name);
  if(!user) return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—");
  if(user.password!==pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†");

  currentUser=name;
  document.getElementById("loginStatus").innerHTML="ğŸ‘¤ "+name+" ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
  document.getElementById("loginBox").classList.add("hidden");
  render();
}

window.logout=function(){
  currentUser=null;
  document.getElementById("loginStatus").innerHTML="æœªãƒ­ã‚°ã‚¤ãƒ³";
  render();
}


// =======================
// é€é‡‘ï¼ˆå®Œå…¨å®‰å…¨ç‰ˆï¼‰
// =======================
window.transfer = async function(){

  if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

  const to=document.getElementById("toUser").value;
  const amount=parseInt(document.getElementById("amount").value);
  const reason=document.getElementById("reason").value.trim();

  if(!reason) return alert("ç†ç”±å¿…é ˆ");
  if(isNaN(amount) || amount<=0) return alert("æ­£ã—ã„é‡‘é¡ã‚’å…¥ã‚Œã¦");
  if(currentUser===to) return alert("è‡ªåˆ†ã«ã¯é€ã‚Œãªã„");

  const fromUser=users.find(u=>u.name===currentUser);
  const toUser=users.find(u=>u.name===to);

  if(fromUser.score<amount) return alert("æ®‹é«˜ä¸è¶³");

  await updateDoc(doc(db,"users",fromUser.id),{
    score:increment(-amount)
  });

  await updateDoc(doc(db,"users",toUser.id),{
    score:increment(amount)
  });

  await addDoc(collection(db,"history"),{
    createdAt:serverTimestamp(),
    date:new Date().toLocaleString(),
    text:`${currentUser} â†’ ${to} | ${amount}pt | ${reason}`
  });

  loadUsers();
  if(isAdmin) loadHistory();
}


// =======================
// ç®¡ç†è€…
// =======================
window.adminLogin=function(){
  if(document.getElementById("adminPass").value===adminPassword){
    isAdmin=true;
    document.getElementById("adminPanel").classList.remove("hidden");
    loadHistory();
  }else{
    alert("é•ã„ã¾ã™");
  }
}

window.adminChange = async function(){

  const name=document.getElementById("adminUser").value;
  const amount=parseInt(document.getElementById("adminAmount").value);
  const reason=document.getElementById("adminReason").value.trim();

  if(isNaN(amount) || amount===0) return alert("æ­£ã—ã„é‡‘é¡");
  if(!reason) return alert("ç†ç”±å¿…é ˆ");

  const user=users.find(u=>u.name===name);

  await updateDoc(doc(db,"users",user.id),{
    score:increment(amount)
  });

  await addDoc(collection(db,"history"),{
    createdAt:serverTimestamp(),
    date:new Date().toLocaleString(),
    text:`ç®¡ç†è€…å¤‰æ›´ | ${name} | ${amount}pt | ${reason}`
  });

  loadUsers();
  loadHistory();
}


// åˆæœŸèµ·å‹•
loadUsers();
</script>
</body>
</html>







