<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Coin</title>

<style>
body{
font-family:sans-serif;
margin:0;
background:linear-gradient(135deg,#eaf6ff,#ffffff);
}
.container{
max-width:900px;
margin:auto;
padding:20px;
}
.topbar{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}
.card{
background:white;
padding:15px;
margin:10px 0;
border-radius:15px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
text-align:center;
}
.rank1{border-left:6px solid gold;}
.rank2{border-left:6px solid silver;}
.rank3{border-left:6px solid #cd7f32;}
button{
background:#0077ff;
color:white;
border:none;
padding:8px 14px;
border-radius:8px;
margin:5px;
cursor:pointer;
}
input,select{
padding:8px;
border-radius:8px;
border:1px solid #ccc;
margin:5px;
width:90%;
}
.hidden{display:none;}
@media(min-width:700px){
.flex{display:flex;gap:20px;}
.left,.right{flex:1;}
}
</style>
</head>

<body>
<div class="container">

<div class="topbar">
<h2>ğŸ¦ Family Coin</h2>
<div>
<span id="loginStatus">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
<button onclick="toggleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
</div>

<div id="loginBox" class="hidden card">
<select id="loginUser"></select><br>
<input type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
<button onclick="login()">å…¥ã‚‹</button>
</div>

<div class="flex">
<div class="left">
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="ranking"></div>
</div>

<div class="right">

<h3>ğŸ’¸ é€é‡‘</h3>
<div id="transferBox" class="hidden">
<select id="toUser"></select><br>
<input type="number" id="amount" placeholder="ãƒã‚¤ãƒ³ãƒˆ"><br>
<input type="text" id="reason" placeholder="ç†ç”±ï¼ˆå¿…é ˆï¼‰"><br>
<button onclick="transfer()">é€ã‚‹</button>
</div>
<div id="needLogin">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨é€é‡‘ã§ãã¾ã™</div>

<hr>

<h3>ğŸ”‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå…„ï¼‰</h3>
<input type="password" id="adminPass">
<button onclick="adminLogin()">ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</button>

<div id="adminPanel" class="hidden">
<select id="adminUser"></select><br>
<input type="number" id="adminAmount" placeholder="å¢—æ¸›ãƒã‚¤ãƒ³ãƒˆ"><br>
<input type="text" id="adminReason" placeholder="ç†ç”±ï¼ˆå¿…é ˆï¼‰"><br>
<button onclick="adminChange()">å¤‰æ›´</button>

<h4>ğŸ“œ å±¥æ­´ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</h4>
<div id="history"></div>
</div>

</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAJhDW-qF9hcGrlu70ythFbp2mOsqu9G-I",
  authDomain: "family-score.firebaseapp.com",
  projectId: "family-score",
  storageBucket: "family-score.firebasestorage.app",
  messagingSenderId: "24020011568",
  appId: "1:24020011568:web:db45e1bc7ee92d40cc7bf5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const adminPassword="nandesitteru";

let users=[];
let currentUser=null;
let isAdmin=false;

async function loadUsers(){
const snapshot=await getDocs(collection(db,"users"));
users=[];
snapshot.forEach(docSnap=>{
users.push({id:docSnap.id,...docSnap.data()});
});
render();
}

function render(){
let sorted=[...users].sort((a,b)=>b.score-a.score);
let html="";
sorted.forEach((u,i)=>{
let rankClass="";
if(i==0)rankClass="rank1";
if(i==1)rankClass="rank2";
if(i==2)rankClass="rank3";
html+=`<div class="card ${rankClass}">${i+1}ä½<br><b>${u.name}</b><br>${u.score} pt</div>`;
});
document.getElementById("ranking").innerHTML=html;

let sel=document.getElementById("loginUser");
sel.innerHTML="";
users.forEach(u=>{ sel.innerHTML+=`<option>${u.name}</option>`; });

let toSel=document.getElementById("toUser");
toSel.innerHTML="";
users.forEach(u=>{
if(u.name!==currentUser){
toSel.innerHTML+=`<option>${u.name}</option>`;
}
});

let adminSel=document.getElementById("adminUser");
adminSel.innerHTML="";
users.forEach(u=>{
adminSel.innerHTML+=`<option>${u.name}</option>`;
});

if(currentUser){
document.getElementById("transferBox").classList.remove("hidden");
document.getElementById("needLogin").classList.add("hidden");
}else{
document.getElementById("transferBox").classList.add("hidden");
document.getElementById("needLogin").classList.remove("hidden");
}
}

window.toggleLogin=function(){
document.getElementById("loginBox").classList.toggle("hidden");
}

window.login = async function(){

let name = document.getElementById("loginUser").value;
let pass = document.getElementById("loginPass").value;

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã™
let user = users.find(u => u.name === name);

if(!user){
alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
return;
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªï¼ˆFirestoreã«passwordãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¿…è¦ï¼‰
if(user.password !== pass){
alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ã¾ã™");
return;
}

// ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
currentUser = name;
document.getElementById("loginStatus").innerHTML = "ğŸ‘¤ " + name + " ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
document.getElementById("loginBox").classList.add("hidden");

render();
}

window.logout=function(){
currentUser=null;
document.getElementById("loginStatus").innerHTML="æœªãƒ­ã‚°ã‚¤ãƒ³";
render();
}

window.transfer=async function(){
let to=document.getElementById("toUser").value;
let amount=parseInt(document.getElementById("amount").value);
let reason=document.getElementById("reason").value.trim();
if(!reason)return alert("ç†ç”±å¿…é ˆ");

let fromUser=users.find(u=>u.name===currentUser);
let toUser=users.find(u=>u.name===to);
if(fromUser.score<amount)return alert("æ®‹é«˜ä¸è¶³");

await updateDoc(doc(db,"users",fromUser.id),{score:fromUser.score-amount});
await updateDoc(doc(db,"users",toUser.id),{score:toUser.score+amount});

await addDoc(collection(db,"history"),{
date:new Date().toLocaleString(),
text:`${currentUser} â†’ ${to} | ${amount}pt | ${reason}`
});

loadUsers();
if(isAdmin)loadHistory();
}

window.adminLogin=function(){
if(document.getElementById("adminPass").value===adminPassword){
isAdmin=true;
document.getElementById("adminPanel").classList.remove("hidden");
loadHistory();
}else{
alert("é•ã„ã¾ã™");
}
}

window.adminChange=async function(){
let name=document.getElementById("adminUser").value;
let amount=parseInt(document.getElementById("adminAmount").value);
let reason=document.getElementById("adminReason").value.trim();
if(!reason)return alert("ç†ç”±å¿…é ˆ");

let user=users.find(u=>u.name===name);

await updateDoc(doc(db,"users",user.id),{score:user.score+amount});

await addDoc(collection(db,"history"),{
date:new Date().toLocaleString(),
text:`ç®¡ç†è€…å¤‰æ›´ | ${name} | ${amount}pt | ${reason}`
});

loadUsers();
loadHistory();
}

async function loadHistory(){
const snapshot=await getDocs(collection(db,"history"));
let html="";

snapshot.forEach(docSnap=>{
const d = docSnap.data();

html += `
${d.date || ""}
 | ${d.from || ""}
 â†’ ${d.to || ""}
 | ${d.amount || 0}pt
 | ${d.reason || ""}
<br>
`;
});

document.getElementById("history").innerHTML = html || "å±¥æ­´ãªã—";
}

loadUsers();
</script>
</body>
</html>

